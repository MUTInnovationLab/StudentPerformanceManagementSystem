<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Struggling student management</ion-title>
    <ion-buttons slot="start">
      <!-- Menu Button (3 dots) -->
      <ion-button (click)="openMenu()">
        <ion-icon name="ellipsis-vertical-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div *ngIf="menuVisible" class="menu">
    <ion-item (click)="goToMeeting()">Go to Meeting</ion-item>
    <ion-item (click)="goToCsv()">Go to CSV</ion-item>
    <ion-item (click)="goToStudentPerformance()">Go to student perfomance</ion-item>
    <ion-item (click)="logout()">Logout</ion-item>
  </div>
  <ion-grid>
    <ion-row class="filter-controls ion-padding">
      <ion-col size="12" size-md="4">
        <ion-item lines="full" class="custom-dropdown">
          <ion-label position="stacked" color="medium">Modules</ion-label>
          <select [(ngModel)]="selectedModule" (ngModelChange)="onModuleChange()" class="form-select">
            <option value="" disabled>Select Module</option>
            <option *ngFor="let module of modules" [value]="module.moduleCode">
              {{ module.moduleName }}
            </option>
          </select>
        </ion-item>
      </ion-col>
   
      <ion-col size="12" size-md="4">
        <ion-item lines="full" class="custom-dropdown">
          <ion-label position="stacked" color="medium">Range</ion-label>
          <select [(ngModel)]="selectedRange" (ngModelChange)="onRangeChange()" class="form-select">
            <option value="0-40">0 - 40</option>
            <option value="41-59">41 - 59</option>
            <option value="60-69">60 - 69</option>
            <option value="70-79">70 - 79</option>
            <option value="80-89">80 - 89</option>
            <option value="90-100">90 - 100</option>
          </select>
        </ion-item>
      </ion-col>
   
      <ion-col size="12" size-md="4">
        <ion-item lines="full" class="custom-dropdown">
          <ion-label position="stacked" color="medium">Order</ion-label>
          <select [(ngModel)]="selectedOrder" (ngModelChange)="onOrderChange()" class="form-select">
            <option value="ascending">Ascending</option>
            <option value="descending">Descending</option>
          </select>
        </ion-item>
      </ion-col>
    </ion-row>

    <ion-row>
      <ion-col>
        <ion-card>
          <ion-card-header>
            <div class="header-cont">
              <ion-card-subtitle class="subtitle">Students Marks for {{selectedModule}}</ion-card-subtitle>
              <div class="filters">
                <ion-input
                  [(ngModel)]="searchText"
                  (ionInput)="handleSearch($event)"
                  placeholder="Search">
                </ion-input>
              </div>
            </div>
          </ion-card-header>
         
          <ion-card-content>
            <div class="table-container">
              <table *ngIf="filteredStudents.length > 0; else noData">
                <thead>
                  <tr>
                    <th>Student Number</th>
                    <th>Test1</th>
                    <th>Test2</th>
                    <th>Test3</th>
                    <th>Test4</th>
                    <th>Average</th>
                    <th>Action</th>
                    <th>  <ion-button color="primary" size="small" (click)="openPerfomance()">
                      Attendance
                    </ion-button></th>
                    <!-- <th>Statistics</th> -->
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let student of filteredStudents">
                    <td >{{ student.studentNumber }}</td>
                    <td >{{ student.test1 }}</td>
                    <td >{{ student.test2 }}</td>
                    <td >{{ student.test3 }}</td>
                    <td >{{ student.test4 }}</td>
                    <td>{{ student.average.toFixed(1) }}%</td>
                    <td>
                      <ion-button color="secondary" size="small" (click)="openViewModal(student)">
                       view
                      </ion-button>
                      <ion-button color="primary" size="small" (click)="openAssignMentorModal(student)">
                        assign
                      </ion-button>
                    
                    </td>
                    <td>
                      <div class="progress-bar" [style.background-image]="getProgressBarStyle(student.average)">
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
              <ng-template #noData>
                <p>No data available for this module.</p>
              </ng-template>      
            </div>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>

<ion-modal 
  [isOpen]="isAttendanceModalOpen" 
  (didDismiss)="closeAttendanceModal()" 
  class="attendance-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Attendance Summary for {{ selectedModule }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeAttendanceModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <ion-list *ngIf="attendanceSummary.length > 0">
        <ion-item *ngFor="let summary of attendanceSummary">
          <ion-label>
            <h2>{{ summary.date }}</h2>
            <p>Total Attendees: {{ summary.totalAttendees }}</p>
            <ion-list>
              <ion-item *ngFor="let studentNumber of getObjectKeys(summary.attendeeDetails)">
                <ion-label>
                  Student {{ studentNumber }}: {{ summary.attendeeDetails[studentNumber] }} attendance(s)
                </ion-label>
                <ion-button 
                  color="primary" 
                  size="small" 
                  (click)="viewStudentAttendance(studentNumber)">
                  View Details
                </ion-button>
              </ion-item>
            </ion-list>
          </ion-label>
        </ion-item>
      </ion-list>
      <p *ngIf="attendanceSummary.length === 0">No attendance records found.</p>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- New modal for individual student attendance -->
<ion-modal 
  [isOpen]="isStudentAttendanceModalOpen" 
  (didDismiss)="closeStudentAttendanceModal()" 
  class="student-attendance-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Attendance Details for Student {{ selectedStudentAttendance?.studentNumber }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeStudentAttendanceModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <ion-list *ngIf="selectedStudentAttendance && selectedStudentAttendance.attendanceDetails.length > 0">
        <ion-item *ngFor="let record of selectedStudentAttendance.attendanceDetails">
          <ion-label>
            <h2>{{ record.date }}</h2>
            <p>Attendance Time: {{ record.attendanceTime }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
      <p *ngIf="selectedStudentAttendance && selectedStudentAttendance.attendanceDetails.length === 0">
        No attendance records found for this student.
      </p>
    </ion-content>
  </ng-template>
</ion-modal>


<ion-modal 
  #mentorModal 
  [isOpen]="isModalOpen" 
  (didDismiss)="closeModal()" 
  class="mentor-modal">
  <ng-template>
    <ion-header class="ion-no-border">
      <ion-toolbar>
        <ion-title>
          Assign Mentor to {{ studentDetails.name+'  '+studentDetails.surname  || selectedStudent?.studentNumber  }}
        </ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeModal()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <ng-container *ngIf="availableMentors.length > 0; else noMentors">
        <ion-list lines="none">
          <ion-list-header>
            <ion-label>Select a Mentor</ion-label>
          </ion-list-header>

          <ion-radio-group [(ngModel)]="selectedMentor">
            <ion-item *ngFor="let mentor of availableMentors">
              <ion-radio slot="start" [value]="mentor"></ion-radio>
              <ion-label>
                <h2>{{ mentor.name }}</h2>
                <p>{{ mentor.email }}</p>
              </ion-label>
            </ion-item>
          </ion-radio-group>
        </ion-list>

        <ion-button 
          class="assign-button" 
          expand="block"
          [disabled]="!selectedMentor"
          (click)="assignMentorToStudent(selectedMentor!)">
          Assign Mentor
        </ion-button>
      </ng-container>

      <ng-template #noMentors>
        <div class="no-mentors">
          <ion-icon name="alert-circle-outline" size="large"></ion-icon>
          <p>No mentors are currently available for this module.</p>
        </div>
      </ng-template>
    </ion-content>
  </ng-template>
</ion-modal>


<ion-modal
 
 #mentorModal 
 [isOpen]="openSelectedStudent "
 class="mentor-modal"
>
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Student Performance Details</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="openSelectedStudent = false">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding" *ngIf="fullstudentDetails">
      <ion-list>
        <ion-item>
          <ion-label>
            <h2>{{ fullstudentDetails.name }} {{ fullstudentDetails.surname }}</h2>
            <p>Student Number: {{ fullstudentDetails.studentNumber }}</p>
          </ion-label>
        </ion-item>

        <ion-item>
          <ion-label>
            <h3>Test Results</h3>
            <ion-grid>
              <ion-row>
                <ion-col>Test 1: {{ fullstudentDetails.test1 }}%</ion-col>
                <ion-col>Test 2: {{ fullstudentDetails.test2 }}%</ion-col>
                <ion-col>Test 3: {{ fullstudentDetails.test3 }}%</ion-col>
                <ion-col>Test 4: {{ fullstudentDetails.test4 }}%</ion-col>
              </ion-row>
              <hr>
              <ion-row>
                <ion-col>Test 5: {{ fullstudentDetails.test5 }}%</ion-col>
                <ion-col>Test 6: {{ fullstudentDetails.test6 }}%</ion-col>
                <ion-col>Test 7: {{ fullstudentDetails.test7 }}%</ion-col>
                <ion-col>Average: {{ fullstudentDetails.studentavg }}%</ion-col>
              </ion-row>
            </ion-grid>
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>





<ion-modal
 
 #mentorModal 
 [isOpen]="openSelectedStudent "
 class="mentor-modal"
>
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Student Performance Details</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="openSelectedStudent = false">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding" *ngIf="fullstudentDetails">
      <ion-list>
        <ion-item>
          <ion-label>
            <h2>{{ fullstudentDetails.name }} {{ fullstudentDetails.surname }}</h2>
            <p>Student Number: {{ fullstudentDetails.studentNumber }}</p>
          </ion-label>
        </ion-item>

        <ion-item>
          <ion-label>
            <h3>Test Results</h3>
            <ion-grid>
              <ion-row>
                <ion-col>Test 1: {{ fullstudentDetails.test1 }}%</ion-col>
                <ion-col>Test 2: {{ fullstudentDetails.test2 }}%</ion-col>
                <ion-col>Test 3: {{ fullstudentDetails.test3 }}%</ion-col>
                <ion-col>Test 4: {{ fullstudentDetails.test4 }}%</ion-col>
              </ion-row>
              <hr>
              <ion-row>
                <ion-col>Test 5: {{ fullstudentDetails.test5 }}%</ion-col>
                <ion-col>Test 6: {{ fullstudentDetails.test6 }}%</ion-col>
                <ion-col>Test 7: {{ fullstudentDetails.test7 }}%</ion-col>
                <ion-col>Average: {{ fullstudentDetails.studentavg }}%</ion-col>
              </ion-row>
            </ion-grid>
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

