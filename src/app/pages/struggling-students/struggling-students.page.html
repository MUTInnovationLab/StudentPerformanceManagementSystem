// src/app/pages/struggling-students/struggling-students.page.html
<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>
      Student Performance Management
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="ion-padding">
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="4">
          <ion-item>
            <ion-label position="stacked">Select Module</ion-label>
            <ion-select [(ngModel)]="selectedModule" (ionChange)="onModuleChange()">
              <ion-select-option *ngFor="let module of modules$ | async" [value]="module.moduleCode">
                {{ module.moduleName }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="4">
          <ion-item>
            <ion-label position="stacked">Minimum Average</ion-label>
            <ion-input type="number" [(ngModel)]="minAverage"></ion-input>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="4" class="ion-align-self-end">
          <ion-button expand="block" (click)="loadStudents()">
            <ion-icon name="search-outline" slot="start"></ion-icon>
            Filter Students
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Struggling Students</ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ion-list>
          <ion-item class="header-row">
            <ion-grid>
              <ion-row>
                <ion-col size="2">
                  <ion-button fill="clear" (click)="sortStudents('studentNumber')">
                    Student No.
                    <ion-icon name="arrow-up-down-outline"></ion-icon>
                  </ion-button>
                </ion-col>
                <ion-col size="3">
                  <ion-button fill="clear" (click)="sortStudents('lastName')">
                    Name
                    <ion-icon name="arrow-up-down-outline"></ion-icon>
                  </ion-button>
                </ion-col>
                <ion-col size="2">Average</ion-col>
                <ion-col size="5">Actions</ion-col>
              </ion-row>
            </ion-grid>
          </ion-item>

          <ion-item *ngFor="let student of students$ | async">
            <ion-label>
              <ion-grid>
                <ion-row>
                  <ion-col size="2">{{ student.studentNumber }}</ion-col>
                  <ion-col size="3">{{ student.surname }}, {{ student.name }}</ion-col>
                  <ion-col size="2">{{ student.average }}%</ion-col>
                </ion-row>
              </ion-grid>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Student Details Modal -->
  <ion-modal [isOpen]="!!selectedStudent">
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Student Performance Details</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeStudentDetails()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <div class="ion-padding" *ngIf="selectedStudent">
        <h2>{{ selectedStudent.name }} {{ selectedStudent.surname }}</h2>
        <p>Student No: {{ selectedStudent.studentNumber }}</p>
        <p>Email: {{ selectedStudent.email }}</p>
        <p>Average Score: {{ selectedStudent.average }}%</p>

        <ion-card>
          <ion-card-header>
            <ion-card-title>Test Scores</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <p>Test 1: {{ selectedStudent.tests?.test1 }}%</p>
            <p>Test 2: {{ selectedStudent.tests?.test2 }}%</p>
            <p>Test 3: {{ selectedStudent.tests?.test3 }}%</p>
          </ion-card-content>
        </ion-card>
      </div>
    </ion-content>
  </ion-modal>

  <!-- Mentor Modal -->
  <ion-modal [isOpen]="showMentorModal">
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Assign Mentor</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="showMentorModal = false">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <div class="ion-padding" *ngIf="selectedStudent">
        <h3>Assign Mentor to {{ selectedStudent.name }} {{ selectedStudent.surname }}</h3>
        <ion-button expand="block" (click)="assignMentor()">Confirm</ion-button>
      </div>
    </ion-content>
  </ion-modal>
</ion-content>