<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title class="t">
      <ion-icon name="document-text-outline" class="title-icon"></ion-icon>
      HOD ANALYTICS
    </ion-title>
    <ion-buttons slot="start">
      <!-- Menu Button (3 dots) -->
      <ion-button (click)="openMenu()">
        <ion-icon name="ellipsis-vertical-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>


<ion-content class="ion-padding custom-content">
  <div *ngIf="menuVisible" class="menu">
    <ion-item (click)="Dashboard()">Dashboard</ion-item>
    <ion-item (click)="goToMeeting()">Go to Meeting</ion-item>
    <ion-item (click)="goToStudentManagement()">Go to student management</ion-item>
    <ion-item (click)="supportfeedback()">Support Feedback</ion-item>
    <ion-item (click)="logout()">Logout</ion-item>
  </div>
  <ion-card class="custom-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="book-outline" class="card-icon"></ion-icon>
        Module Information
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item lines="none" class="custom-item">
        <ion-label position="floating">Module Code</ion-label>
        <ion-input [(ngModel)]="moduleCode" class="custom-input"></ion-input>
      </ion-item>
    </ion-card-content>
  </ion-card>

  <ion-card class="custom-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="calculator-outline" class="card-icon"></ion-icon>
        Average Calculation
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item lines="none" class="custom-toggle">
        <ion-label>Calculate Average</ion-label>
        <ion-toggle [(ngModel)]="calculateAverage" (ionChange)="toggleCalculateAverage()" slot="end"></ion-toggle>
      </ion-item>

      <ion-grid *ngIf="calculateAverage">
        <ion-row>
          <ion-col size="12" size-md="6" size-lg="3" *ngFor="let test of tests; let i = index">
            <ion-item lines="none" class="custom-item">
              <ion-label position="floating">Test {{i + 1}} %</ion-label>
              <ion-input 
                type="number" 
                [(ngModel)]="test.percentage" 
                (ionChange)="calculateAverages()"
                class="custom-input">
              </ion-input>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <ion-card class="custom-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="cloud-upload-outline" class="card-icon"></ion-icon>
        File Operations
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-button expand="block" (click)="generateSpreadsheet()" [disabled]="isLoading" class="custom-button">
        <ion-icon name="download-outline" slot="start"></ion-icon>
        <ion-spinner name="crescent" *ngIf="isLoading"></ion-spinner>
        <span *ngIf="!isLoading">Generate Template</span>
      </ion-button>

      <ion-item lines="none" class="custom-file-input">
        <ion-label>Upload Spreadsheet</ion-label>
        <input type="file" (change)="onFileChange($event)" accept=".xlsx, .xls" [disabled]="isLoading">
      </ion-item>

      <ion-button expand="block" (click)="previewSpreadsheet()" [disabled]="!file || isLoading" class="custom-button">
        <ion-icon name="eye-outline" slot="start"></ion-icon>
        <ion-spinner name="crescent" *ngIf="isLoading"></ion-spinner>
        <span *ngIf="!isLoading">Preview Spreadsheet</span>
      </ion-button>

      <ion-button expand="block" (click)="uploadToFirestore()" [disabled]="previewData.length === 0 || isLoading" class="custom-button">
        <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
        <ion-spinner name="crescent" *ngIf="isLoading"></ion-spinner>
        <span *ngIf="!isLoading">Upload to Firestore</span>
      </ion-button>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="previewData.length > 0" class="custom-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="list-outline" class="card-icon"></ion-icon>
        Data Preview
      </ion-card-title>
    </ion-card-header>
    <ion-card-content class="table-container">
      <ion-grid class="custom-table">
        <ion-row class="header-row">
          <ion-col>Student Number</ion-col>
          <ion-col *ngFor="let test of tests; let i = index">Test {{i + 1}}</ion-col>
          <ion-col *ngIf="calculateAverage">Average</ion-col>
        </ion-row>
        <ion-row class="data-row" *ngFor="let row of previewData">
          <ion-col>{{row.studentNumber}}</ion-col>
          <ion-col *ngFor="let test of tests; let i = index">{{row['test' + (i + 1)]}}</ion-col>
          <ion-col *ngIf="calculateAverage">{{row.average}}%</ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>
</ion-content>

<ion-toast
  [isOpen]="isToastOpen"
  [message]="toastMessage"
  [color]="toastColor"
  [duration]="3000"
  (didDismiss)="isToastOpen = false">
</ion-toast>

<ion-loading
  [isOpen]="isLoading"
  message="Please wait..."
  [duration]="3000">
</ion-loading>